var amazonPrimePage=function(){"use strict";function g(e){return e==null||typeof e=="function"?{main:e}:e}function h(e,o){const a=e.lastIndexOf(".");let r=o;if(a!==-1){r=e.substring(a+1);const d=r.indexOf("?");d!==-1&&(r=r.substring(0,d))}return r}function w(e,o=1e4){return new Promise(async(a,r)=>{e()&&a(!0);const d=Date.now();let p=!1;for(;!p&&Date.now()<d+o;)await new Promise(f=>{setTimeout(()=>{p=e(),f()},1e3)});a(p)})}const R=e=>`${e.language}:${e.label}:${e.url}`,v=g(()=>{const e={},o=(n,t)=>new URLSearchParams(new URL(n).search).get(t);let a;const r=window.XMLHttpRequest.prototype.open;window.XMLHttpRequest.prototype.open=function(){const n=arguments[1];if(typeof n=="string"){if(n.includes("GetVodPlaybackResources")){const t=o(n,"titleId");if(t){const s=e[t]??{};s.vodPlaybackResourcesUrl=n,e[t]=s,a=t,this._vodPlaybackResourcesTitleId=t}}if(n.includes("playerChromeResources")&&n.includes("catalogMetadataV2")){const t=o(n,"entityId");if(t){const s=e[t]??{};s.playerChromeResourcesUrl=n,e[t]=s,a=t}}}r.apply(this,arguments)};const d=window.XMLHttpRequest.prototype.send;window.XMLHttpRequest.prototype.send=function(){this._vodPlaybackResourcesTitleId&&typeof arguments[0]=="string"&&(e[this._vodPlaybackResourcesTitleId].vodPlaybackResourceBody=arguments[0]),d.apply(this,arguments)};const p=async n=>{var i,c,l;const t=(l=(c=(i=await(await fetch(n)).json())==null?void 0:i.resources)==null?void 0:c.catalogMetadataV2)==null?void 0:l.catalog;if(!t)return"";const s=[];if(typeof t.seriesTitle=="string"){const u=[];u.push(t.seriesTitle),typeof t.seasonNumber=="number"&&u.push(`S${t.seasonNumber}`),typeof t.episodeNumber=="number"&&u.push(`E${t.episodeNumber}`),s.push(u.join("."))}return typeof t.title=="string"&&s.push(t.title),s.join(" - ")},f=async(n,t)=>{var l,u;const s=await(await fetch(n,{method:"POST",body:t,credentials:"include"})).json(),i=(u=(l=s==null?void 0:s.timedTextUrls)==null?void 0:l.result)==null?void 0:u.subtitleUrls,c=[];if(i instanceof Array)for(const m of i){const b={label:m.displayName,language:m.languageCode.toLowerCase(),url:m.url,extension:h(m.url,"ttml2")};c.push({id:R(b),...b})}return c};document.addEventListener("asbplayer-get-synced-data",async()=>{try{if(a){const n=a;if(await w(()=>{const s=e[n];return!!(s&&s.playerChromeResourcesUrl&&s.vodPlaybackResourcesUrl&&s.vodPlaybackResourceBody)})){const s=e[n],i=await p(s.playerChromeResourcesUrl),c=await f(s.vodPlaybackResourcesUrl,s.vodPlaybackResourceBody),l={basename:i,subtitles:c};document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:l}))}else document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:{error:"Could not capture metadata",basename:"",subtitles:[]}}))}else document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:{error:"Could not capture video ID",basename:"",subtitles:[]}}))}catch(n){const t=n instanceof Error?n.message:String(n);document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:{error:t}}))}},!1)});function k(){}function y(e,...o){}const P={debug:(...e)=>y(console.debug,...e),log:(...e)=>y(console.log,...e),warn:(...e)=>y(console.warn,...e),error:(...e)=>y(console.error,...e)};return(async()=>{try{return await v.main()}catch(e){throw P.error('The unlisted script "amazon-prime-page" crashed on startup!',e),e}})()}();
amazonPrimePage;
