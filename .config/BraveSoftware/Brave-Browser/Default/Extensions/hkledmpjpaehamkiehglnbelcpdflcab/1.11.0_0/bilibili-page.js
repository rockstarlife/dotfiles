var bilibiliPage=function(){"use strict";function y(t){return t==null||typeof t=="function"?{main:t}:t}function g(t,n){const o=t.lastIndexOf(".");let a=n;if(o!==-1){a=t.substring(o+1);const e=a.indexOf("?");e!==-1&&(a=a.substring(0,e))}return a}function m(t,n=1e4){return new Promise(async(o,a)=>{t()&&o(!0);const e=Date.now();let i=!1;for(;!i&&Date.now()<e+n;)await new Promise(s=>{setTimeout(()=>{i=t(),s()},1e3)});o(i)})}const w=t=>`${t.language}:${t.label}:${t.url}`;function h({onJson:t,onRequest:n,waitForBasename:o},a){setTimeout(()=>{const e={};let i="",s=!1;if(t!==void 0){const r=JSON.parse;JSON.parse=function(){const c=r.apply(this,arguments);let l=!1,u=!1;return t==null||t(c,d=>{const p=window.location.pathname;typeof e[p]>"u"&&(e[p]=[]);const b=w(d);e[p].find(v=>v.id===b)===void 0&&(e[p].push({id:b,...d}),l=!0)},d=>{i=d,u=!0}),s&&(l||u)&&document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:{error:"",basename:i,subtitles:e[window.location.pathname]}})),c}}function E(){for(const r of Object.keys(e))r!==window.location.pathname&&delete e[r]}document.addEventListener("asbplayer-get-synced-data",async()=>{n==null||n(c=>{const l=window.location.pathname;typeof e[l]>"u"&&(e[l]=[]);const u=w(c);e[l].find(d=>d.id===u)===void 0&&e[l].push({id:u,...c})},c=>{i=c,s||document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:{error:"",basename:i,subtitles:void 0}}))});const r=()=>window.location.pathname in e;r()||await m(r,a),document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:{error:"",basename:i,subtitles:e[window.location.pathname]??[]}})),E(),s=!0},!1)},0)}const x=y(()=>{h({onJson:(t,n)=>{var o,a;if(((o=t==null?void 0:t.data)==null?void 0:o.subtitles)instanceof Array){for(const e of t.data.subtitles)if(typeof e.lang=="string"&&typeof e.lang_key=="string"&&(typeof e.srt=="object"&&typeof e.srt.url=="string"||typeof e.url=="string")){const i=((a=e.srt)==null?void 0:a.url)??e.url,s=g(i,"srt");n({label:e.lang,language:e.lang_key,url:i,extension:s==="json"?"bbjson":s})}}},onRequest:(t,n)=>{n(document.title)},waitForBasename:!1})});function I(){}function f(t,...n){}const k={debug:(...t)=>f(console.debug,...t),log:(...t)=>f(console.log,...t),warn:(...t)=>f(console.warn,...t),error:(...t)=>f(console.error,...t)};return(async()=>{try{return await x.main()}catch(t){throw k.error('The unlisted script "bilibili-page" crashed on startup!',t),t}})()}();
bilibiliPage;
