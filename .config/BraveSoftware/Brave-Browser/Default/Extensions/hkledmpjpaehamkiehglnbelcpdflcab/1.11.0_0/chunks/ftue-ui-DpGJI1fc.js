var U=Object.defineProperty;var L=(o,e,t)=>e in o?U(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var f=(o,e,t)=>L(o,typeof e!="symbol"?e+"":e,t);import{b as d}from"./index-BNzDLOmD.js";import{g as O,a as B,r as h,u as K,j as n,s as z,c as F,b as H,S as N,E as $,l as w,d as q,P as T,F as W,I as G,m as X,e as Y,f as Q,T as J,C as Z,h as ee,i as E,k as te}from"./Tooltip-CHkWPQyT.js";import{P as se,C as ne,a as j}from"./PlayArrow-C9tdK3Bw.js";import{u as ae,B as ie,a as A}from"./index-BSUPl2ka.js";import{T as x,a as b,L as S}from"./TutorialBubble-5H5VcrSJ.js";import{i as v}from"./index-DGAt_zbA.js";import{D as P,a as k}from"./DialogContent-UtFnDA1U.js";class oe{constructor(e){f(this,"_settings");f(this,"_onSyncedElementCallbacks",[]);f(this,"_onAsbplayerInstanceCallbacks",[]);this._settings=e,d.tabs.onRemoved.addListener((t,a)=>{this._removeVideoElementsInTab(t),this._removeAsbplayersInTab(t)}),d.tabs.onUpdated.addListener((t,a)=>{let s=!1;(a.status==="loading"&&a.url===void 0||a.url!==void 0)&&(s=!0),s&&(this._removeVideoElementsInTab(t),this._removeAsbplayersInTab(t))})}async _fetchVideoElementState(){const e=await d.storage.session.get("tabRegistryVideoElements");return(e&&e.tabRegistryVideoElements)??{}}async _saveVideoElementState(e){await d.storage.session.set({tabRegistryVideoElements:e})}async _removeVideoElementsInTab(e){await this._videoElements(t=>{let a=!1;for(const[s,i]of Object.entries(t))i.tab.id===e&&(delete t[s],a=!0);return a})}async _videoElements(e){const t=await this._fetchVideoElementState(),a={...t};let s=!1;e!==void 0&&(s=e(t)||s),s&&await this._saveVideoElementState(t);const i=Object.values(a).find(r=>r.synced)!==void 0,l=Object.values(t).find(r=>r.synced)!==void 0;if(this._onSyncedElementCallbacks.length>0&&!i&&l)for(const r of this._onSyncedElementCallbacks)r();return t}async _fetchAsbplayerState(){const e=await d.storage.session.get("tabRegistryAsbplayers");return(e&&e.tabRegistryAsbplayers)??{}}async _saveAsbplayerState(e){await d.storage.session.set({tabRegistryAsbplayers:e})}async _removeAsbplayersInTab(e){await this._asbplayers(t=>{var s;let a=!1;for(const[i,l]of Object.entries(t))((s=l.tab)==null?void 0:s.id)===e&&(delete t[i],a=!0);return a})}async _asbplayers(e){const t=await this._fetchAsbplayerState(),a={...t};let s=!1;const i=Date.now();for(const r in t){const c=t[r];c.sidePanel&&i-c.timestamp>=5e3&&(s=!0,delete t[r])}e!==void 0&&(s=e(t)||s);let l=!1;if(s&&(await this._saveAsbplayerState(t),l=Object.keys(t).some(r=>!(r in a))),l)for(const r of this._onAsbplayerInstanceCallbacks)r();return t}async onAsbplayerHeartbeat(e,{id:t,videoPlayer:a,sidePanel:s,receivedTabs:i,loadedSubtitles:l,syncedVideoElement:r}){this._updateAsbplayers(e,t,a,s??!1,l??!1,i,r);try{const c={sender:"asbplayer-extension-to-player",message:{command:"tabs",tabs:await this.activeVideoElements(),asbplayers:await this._asbplayerInstances(),ackRequested:!1}};e!=null&&e.id?await d.tabs.sendMessage(e.id,c):await d.runtime.sendMessage(c)}catch{}}async onAsbplayerAckTabs(e,{id:t,videoPlayer:a,sidePanel:s,loadedSubtitles:i,receivedTabs:l,syncedVideoElement:r}){this._updateAsbplayers(e,t,a,s??!1,i??!1,l,r)}async _updateAsbplayers(e,t,a,s,i,l,r){const c=e===void 0||e.id===void 0?void 0:{id:e.id,title:e.title??"",url:e.url??"",faviconUrl:e.favIconUrl};await this._asbplayers(u=>(u[t]={tab:c,id:t,timestamp:Date.now(),receivedTabs:l,sidePanel:s,loadedSubtitles:i,videoPlayer:a,syncedVideoElement:r},!0))}async activeVideoElements(){const e=await this._videoElements(),t=[];for(const a in e){const s=e[a];if(s.tab.id){const i={id:s.tab.id,title:s.tab.title,faviconUrl:s.tab.faviconUrl,src:s.src,subscribed:s.subscribed,synced:s.synced,syncedTimestamp:s.syncedTimestamp};t.push(i)}}return t}async _asbplayerInstances(){var a;const e=await this._asbplayers(),t=[];for(const s of Object.values(e))t.push({id:s.id,tabId:(a=s.tab)==null?void 0:a.id,sidePanel:s.sidePanel??!1,timestamp:s.timestamp,videoPlayer:s.videoPlayer});return t}async onVideoElementHeartbeat(e,t,{subscribed:a,synced:s,syncedTimestamp:i,loadedSubtitles:l}){if(e.id===void 0)return;const r=e.id;await this._videoElements(c=>(c[`${e.id}:${t}`]={tab:{id:r,title:e.title??"",url:e.url??"",faviconUrl:e.favIconUrl},src:t,subscribed:a,timestamp:Date.now(),synced:s,syncedTimestamp:i,loadedSubtitles:l},!0))}async onVideoElementDisappeared(e,t){await this._videoElements(a=>{const s=`${e.id}:${t}`;return s in a?(delete a[s],!0):!1})}onSyncedElement(e){this._onSyncedElementCallbacks.push(e)}onAsbplayerInstance(e){this._onAsbplayerInstanceCallbacks.push(e)}async publishTabsToAsbplayers(){const e={sender:"asbplayer-extension-to-player",message:{command:"tabs",tabs:await this.activeVideoElements(),asbplayers:await this._asbplayerInstances(),ackRequested:!0}};await this.publishCommandToAsbplayers({commandFactory:t=>t.videoPlayer?void 0:e})}async publishCommandToAsbplayers({asbplayerId:e,commandFactory:t}){const a=await this._asbplayers();if(e!==void 0){if(e in a){const s=a[e],i=t(s);i!==void 0&&await this._sendCommand(a[e],i)}}else for(const s in a){const i=a[s],l=t(i);l!==void 0&&await this._sendCommand(i,l)}}async _sendCommand(e,t){var a;try{((a=e.tab)==null?void 0:a.id)!==void 0?await d.tabs.sendMessage(e.tab.id,t):e.sidePanel&&await d.runtime.sendMessage(t)}catch{}}async publishCommandToVideoElements(e){const t=await this._videoElements();for(const a in t){const s=t[a],i=s.tab.id;if(typeof i<"u"){const l=e(s);l!==void 0&&d.tabs.sendMessage(i,l)}}}async publishCommandToVideoElementTabs(e){const t=await this._videoElements(),a=[];for(const s of Object.values(t))a.find(i=>i.id===s.tab.id)===void 0&&a.push(s.tab);if(a.length>0)for(const s of a){const i=e(s);i!==void 0&&d.tabs.sendMessage(s.id,i)}}async findAsbplayer({filter:e,allowTabCreation:t}){let a=null;const s=Date.now();let i=null;const l=await this._asbplayers();let r=0;for(const c in l){const u=l[c];if(u.sidePanel||++r,e===void 0||e(u)){const y=s-u.timestamp;(i===null||y<i)&&(i=y,a=u.id)}}if(a)return a;if(t)return new Promise(async(c,u)=>{r===0&&await this._createNewTab(),this._anyAsbplayerTab(c,u,0,10,e)})}async _createNewTab(){return new Promise(async(e,t)=>{const a=await d.tabs.query({active:!0}),s=!a||a.length===0?void 0:a[0].index+1;d.tabs.create({active:!1,url:await this._settings.getSingle("streamingAppUrl"),index:s},e)})}async _anyAsbplayerTab(e,t,a,s,i){if(a>=s){t(new Error("Could not find or create an asbplayer tab"));return}const l=await this._asbplayers();for(const r in l)if(i===void 0||i(l[r])){e(r);return}setTimeout(()=>this._anyAsbplayerTab(e,t,a+1,s,i),1e3)}}function re(o){return O("MuiDialogActions",o)}B("MuiDialogActions",["root","spacing"]);const le=o=>{const{classes:e,disableSpacing:t}=o;return H({root:["root",!t&&"spacing"]},re,e)},ce=z("div",{name:"MuiDialogActions",slot:"Root",overridesResolver:(o,e)=>{const{ownerState:t}=o;return[e.root,!t.disableSpacing&&e.spacing]}})({display:"flex",alignItems:"center",padding:8,justifyContent:"flex-end",flex:"0 0 auto",variants:[{props:({ownerState:o})=>!o.disableSpacing,style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),I=h.forwardRef(function(e,t){const a=K({props:e,name:"MuiDialogActions"}),{className:s,disableSpacing:i=!1,...l}=a,r={...a,disableSpacing:i},c=le(r);return n.jsx(ce,{className:F(c.root,s),ownerState:r,ref:t,...l})}),R=new N(new $),_=new oe(R),V=2147483648,de=()=>{const[o,e]=h.useState(),[t,a]=h.useState(),[s,i]=h.useState();return h.useEffect(()=>{d.tabs.getCurrent().then(l=>i(l==null?void 0:l.id))},[]),h.useEffect(()=>{const l=setInterval(()=>{_.findAsbplayer({filter:r=>r.sidePanel??!1,allowTabCreation:!1}).then(r=>e(r!==void 0)),_.activeVideoElements().then(async r=>{var u;const c=r.find(y=>y.id===s&&y.synced);if(c!==void 0){const y={sender:"asbplayerv2",message:{command:"request-subtitles"},tabId:c.id,src:c.src},m=await d.runtime.sendMessage(y);a((u=m==null?void 0:m.subtitles)==null?void 0:u.length)}})},1e3);return()=>clearInterval(l)},[s]),{sidePanelOpen:o,loadedSubtitlesCount:t}},ue=({show:o,onConfirm:e})=>n.jsx(x,{show:o,placement:"bottom",text:n.jsx(b,{i18nKey:"ftue.toolbar",components:[n.jsx("b",{children:"asbplayer"},0),n.jsx("b",{children:"Popup"},1),n.jsx("p",{},2)],values:{pin:v?"âš™":"ðŸ“Œ"}}),onConfirm:e,children:n.jsx("div",{style:{position:"fixed",right:v?60:185,top:5}})}),he=({open:o,count:e,onClose:t})=>n.jsxs(P,{style:{zIndex:V},open:o,children:[n.jsxs(k,{children:[e===void 0&&!w.isMobile&&!v&&n.jsx(b,{i18nKey:"ftue.loadSubtitles",components:[n.jsx("b",{children:"Side Panel"},0),n.jsx("p",{},1),n.jsx("b",{children:"Side Panel"},2),n.jsx("b",{children:"Popup"},3)]}),e===void 0&&!w.isMobile&&v&&n.jsx(b,{i18nKey:"ftue.loadSubtitlesFirefox",components:[n.jsx("b",{children:"Right-click"},0),n.jsx("b",{children:"context menu"},2)]}),e===void 0&&w.isMobile&&n.jsx(b,{i18nKey:"ftue.loadSubtitlesMobile",components:[n.jsx("b",{children:"asbplayer"},0),n.jsx("b",{children:"extensions"},1)]})]}),v&&n.jsx(I,{children:n.jsx(A,{onClick:t,children:n.jsx(b,{i18nKey:"action.ok"})})})]}),pe=({show:o,onConfirm:e})=>n.jsx(x,{show:o,placement:"left",text:n.jsx(b,{i18nKey:"ftue.sidePanel",components:[n.jsx("b",{children:"Side Panel"},0),n.jsx("b",{children:"navigate"},1),n.jsx("b",{children:"mine"},2)]}),onConfirm:e,children:n.jsx("div",{style:{position:"absolute",right:0,top:"10%"}})}),be=({show:o,onConfirm:e})=>n.jsx(x,{show:o,placement:"bottom",text:n.jsx(b,{i18nKey:"ftue.overlay",components:[n.jsx("b",{children:"Video Overlay"},0),n.jsx("b",{children:"toggle"},1),n.jsx("b",{children:"mine"},2),n.jsx("b",{children:"switch playback modes"},3)]}),onConfirm:e,children:n.jsx("div",{style:{position:"absolute",top:55,left:"50%",transform:"translateX(calc(-50% - 85px))"}})}),ye=({show:o,onConfirm:e})=>n.jsx(x,{show:o,placement:"bottom",text:n.jsx(b,{i18nKey:"ftue.overlayScroll",components:[n.jsx("b",{children:"Scroll"},0),n.jsx("b",{children:"subtitle navigation"},1),n.jsx("b",{children:"subtitle offset"},2),n.jsx("b",{children:"playback rate"},3)]}),onConfirm:e,children:n.jsx("div",{style:{position:"absolute",top:55,left:"50%",transform:"translateX(calc(-50% + 80px))"}})}),fe=({open:o,onClose:e})=>n.jsxs(P,{open:o,style:{zIndex:V},children:[n.jsx(k,{children:n.jsx(b,{i18nKey:"ftue.congrats",components:[n.jsx(S,{href:"/options.html#about",target:"_blank",rel:"noreferrer",children:"Settings"},0),n.jsx("p",{},1),n.jsx(S,{href:"https://docs.asbplayer.dev/docs/intro/",target:"_blank",rel:"noreferrer",children:"user guide"},2)]})}),n.jsx(I,{children:n.jsx(A,{onClick:e,children:"OK"})})]}),me=({className:o,show:e})=>{const{sidePanelOpen:t,loadedSubtitlesCount:a}=de(),[s,i]=h.useState(1);h.useEffect(()=>{s===1&&w.isMobile&&i(2)},[s]),h.useEffect(()=>{s===2&&a!==void 0&&i(t?3:4)},[s,t,a]),h.useEffect(()=>{s==4&&R.getSingle("streamingEnableOverlay").then(p=>{var g;p?(g=c.current)==null||g.pause():i(6)})},[s]);const[l,r]=h.useState(!1),c=h.useRef(),u=()=>{var p,g;l?(p=c.current)==null||p.pause():(g=c.current)==null||g.play()},y=q(),m=ae(y.breakpoints.down("sm")),[D,M]=h.useState(!0);return n.jsxs(T,{square:!0,sx:{position:"relative"},className:o,children:[e&&n.jsx(W,{in:!0,children:n.jsx(ie,{sx:{position:"absolute",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx("div",{style:{width:m?"100%":"80%",maxHeight:"100dvh"},children:n.jsxs("div",{style:{position:"relative",width:"100%",height:"100%",maxHeight:"100dvh"},children:[n.jsx("video",{ref:p=>{c.current=p,p&&(p.volume=Math.min(p.volume,.5))},onPlay:()=>r(!0),onPause:()=>r(!1),style:{width:"100%",maxHeight:"100dvh"},src:d.runtime.getURL("/assets/tutorial.mp4"),onClick:u}),n.jsx("div",{style:{position:"absolute",transform:"translateY(-50%) translateX(-50%) scale(400%)",top:"50%",left:"50%"},children:!l&&n.jsx(G,{onClick:()=>{var p;return(p=c.current)==null?void 0:p.play()},children:n.jsx(se,{})})}),n.jsx(be,{show:e&&s===4,onConfirm:()=>i(5)}),n.jsx(ye,{show:e&&s===5,onConfirm:()=>i(6)})]})})})}),n.jsx(ue,{show:e&&s===1,onConfirm:()=>i(2)}),n.jsx(pe,{show:e&&s===3,onConfirm:()=>i(4)}),n.jsx(he,{open:e&&s===2&&D,count:a,onClose:()=>M(!1)}),n.jsx(fe,{open:e&&s===6,onClose:()=>i(7)})]})},ge=X({container:{scrollSnapType:"y mandatory",width:"100dvw",height:"100dvh",overflowY:"scroll"},child:{scrollSnapAlign:"center",width:"100dvw",height:"100dvh"}}),ve=({className:o})=>{const{t:e}=ee();return n.jsxs(ne,{className:o,direction:"column",children:[n.jsx(j,{children:n.jsx("img",{style:{width:75},src:d.runtime.getURL("/icon/image.png")})}),n.jsx(j,{children:n.jsx(E,{variant:"h5",children:e("ftue.welcome")})}),n.jsx(j,{children:n.jsx(E,{variant:"h6",children:n.jsx(b,{i18nKey:"ftue.welcomeBody2",components:[n.jsx(S,{color:"primary",target:"_blank",rel:"noreferrer",href:"https://docs.asbplayer.dev/docs/intro/",children:"readme"},0)]})})})]})},we=()=>{const[o,e]=h.useState();return h.useEffect(()=>e(new URLSearchParams(window.location.search).get("lang")??void 0),[]),o},xe=()=>{const o=Y("dark"),e=we(),{initialized:t}=Q({language:e??d.i18n.getUILanguage()}),a=ge(),[s,i]=h.useState(!1),[l,r]=h.useState(!1),c=u=>{u&&(u.onscrollend=()=>{u.scrollTop>window.innerHeight*3/4&&(r(!0),i(!0))})};return t?n.jsxs(J,{theme:o,children:[n.jsx(Z,{}),n.jsxs(T,{ref:c,className:a.container,square:!0,children:[!l&&n.jsx(ve,{className:a.child}),n.jsx(me,{show:s,className:a.child})]})]}):null};function je(o){te.createRoot(o).render(n.jsx(xe,{}))}const Se=[{host:"www\\.netflix\\.com",script:"netflix-page.js",path:"watch",autoSync:{enabled:!0}},{host:"(m|www)\\.youtube\\.com",script:"youtube-page.js",path:"watch|shorts|embed",autoSync:{enabled:!0}},{host:"tver\\.jp",script:"tver-page.js",path:"episodes",autoSync:{enabled:!0}},{host:"www\\.b-ch\\.com",script:"bandai-channel-page.js",path:"titles",autoSync:{enabled:!0}},{host:"www\\.amazon\\..+|www\\.primevideo\\.com",script:"amazon-prime-page.js",path:".*",autoSync:{enabled:!0,videoSrc:"^blob:.+"},ignore:{class:"tst-video-overlay-player-html5",style:{display:"none"}}},{host:"www\\.hulu\\..+",script:"hulu-page.js",path:"watch",autoSync:{enabled:!0,elementId:"content-video-player"}},{host:"www\\.disneyplus\\..+",script:"disney-plus-page.js",path:"video|play",searchShadowRoots:!0,autoSync:{enabled:!0}},{host:"www\\.apps\\.disneyplus\\..+",script:"apps-disney-plus-page.js",path:"watch",searchShadowRoots:!0,autoSync:{enabled:!0}},{host:"video.unext.jp",script:"unext-page.js",path:"play",autoSync:{enabled:!1}},{host:".+\\.viki\\.(io|com)",script:"viki-page.js",path:"videos",autoSync:{enabled:!0}},{host:"(jellyfin.*)|(emby.*)|(:8096$)",script:"emby-jellyfin-page.js",hash:"#!/videoosd/videoosd.html|#/video",autoSync:{enabled:!0}},{host:"www.twitch.tv",allowBlankSrc:!0},{host:"osnplus.com",script:"osnplus-page.js",path:"watch",autoSync:{enabled:!0}},{host:"www.bilibili.tv",script:"bilibili-page.js",path:"play|video",autoSync:{enabled:!0}},{host:"tv.nrk.no",script:"nrk-tv-page.js",path:".*",autoSync:{enabled:!0}},{host:"(plex.*)|(:32400$)",script:"plex-page.js",path:".*",autoSync:{enabled:!0}},{host:"areena.yle.fi",script:"areena-yle-page.js",path:".*",autoSync:{enabled:!0}},{host:"play.max.com",script:"hbo-max-page.js",path:"watch",autoSync:{enabled:!0}}],Ee={pages:Se},_e=()=>window.location.href.startsWith(d.runtime.getURL("/ftue-ui.html"));function Ce(){const o=new URL(window.location.href);for(const e of Ee.pages)if(new RegExp(e.host).test(o.host))return new C(e,o);if(_e())return new C({host:window.location.host,script:"asbplayer-tutorial-page.js",path:".*",autoSync:{enabled:!1}},o)}class C{constructor(e,t){f(this,"config");f(this,"url");this.config=e,this.url=t}loadScripts(){if(this.config.script===void 0)return;const e=document.createElement("script");e.src=d.runtime.getURL(`${this.config.script}`),e.onload=()=>e.remove(),(document.head||document.documentElement).appendChild(e)}shouldIgnore(e){if(this.config.ignore===void 0)return!1;if(this.config.ignore.class!==void 0&&e.classList.contains(this.config.ignore.class))return!0;if(this.config.ignore.style!==void 0){for(const t of Object.keys(this.config.ignore.style))if(e.style[t]===this.config.ignore.style[t])return!0}return!1}canAutoSync(e){return this.config.autoSync!==void 0&&this.config.autoSync.enabled&&(this.config.autoSync.elementId===void 0||e.id===this.config.autoSync.elementId)&&(this.config.autoSync.videoSrc===void 0||new RegExp(this.config.autoSync.videoSrc).test(e.src))}isVideoPage(){var e=!0,t=!0;return this.config.hash&&(e=new RegExp(this.config.hash).test(this.url.hash)),this.config.path&&(t=new RegExp(this.config.path).test(this.url.pathname)),e&&t}}window.addEventListener("load",()=>{var e;(e=Ce())==null||e.loadScripts();const o=document.getElementById("root");je(o)});
