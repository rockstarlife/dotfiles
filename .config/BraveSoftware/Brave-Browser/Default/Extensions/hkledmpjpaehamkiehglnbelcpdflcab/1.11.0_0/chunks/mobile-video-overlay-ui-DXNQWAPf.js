import{b as v}from"./index-BNzDLOmD.js";import{r as n,n as re,j as s,o as ye,l as te,I as L,m as ae,p as l,R as oe,G as R,h as ge,q as D,t as Y,S as ve,E as Te,f as ke,e as Se,T as xe,C as Ce,k as Me}from"./Tooltip-CHkWPQyT.js";import{T as je,S as Re,P as we,F as Ne,N as Ie,a as Ee,b as De,c as Le}from"./TimeDisplay-DmNO05HN.js";import{L as Pe}from"./LogoIcon-B8iZypNR.js";import{S as Be}from"./Input-CyGuovd8.js";const Oe=({location:t})=>{const[e,b]=n.useState();return n.useEffect(()=>{if(!t)return;const o=async()=>{const a={sender:"asbplayer-mobile-overlay-to-video",message:{command:"request-mobile-overlay-model"},src:t.src},h=await v.runtime.sendMessage(a);b(h)};let c,p=!1;const m=async()=>{try{if(p)return;await o()}catch(a){console.log("Failed to request overlay model, retrying in 1s. Message: "+(a instanceof Error?a.message:String(a))),c=setTimeout(()=>m(),1e3)}};return m(),()=>{c!==void 0&&clearTimeout(c),p=!0}},[t]),n.useEffect(()=>{if(!t)return;const o=(c,p,m)=>{if(c.sender!=="asbplayer-video-to-mobile-overlay"||c.src!==t.src)return;b(c.message.model)};return v.runtime.onMessage.addListener(o),()=>v.runtime.onMessage.removeListener(o)},[t]),e},Ae=()=>{const[t,e]=n.useState();return n.useEffect(()=>{(async()=>{const o={sender:"asbplayer-mobile-overlay",message:{command:"current-tab"}},c=await v.runtime.sendMessage(o);if(c===void 0)return;const p=new URLSearchParams(window.location.search).get("src");p&&e({src:p,tabId:c})})()},[]),t},He=re(s.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"NavigateBefore"),Ve=re(s.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"NavigateNext"),ze=t=>s.jsx(ye,{...t,children:s.jsx("path",{d:"M20 4H6.83l8 8H20v2h-3.17l4.93 4.93c.15-.28.24-.59.24-.93V6c0-1.1-.9-2-2-2M1.04 3.87l1.2 1.2C2.09 5.35 2 5.66 2 6v12c0 1.1.9 2 2 2h13.17l2.96 2.96 1.41-1.41L2.45 2.45zM8 12v2H4v-2zm6 4.83V18H4v-2h9.17z"})}),se=({onHold:t,onClick:e,children:b,...o})=>{const[c,p]=n.useState(),m=n.useCallback(()=>c===void 0?void 0:(Date.now()-c)/250,[c]),a=()=>{const u=m();u!==void 0&&u<1&&(e==null||e()),p(void 0)},h=()=>{p(Date.now())};return n.useEffect(()=>{if(c===void 0)return;const u=setInterval(()=>{const y=m();y!==void 0&&y>0&&(t==null||t(y))},250);return()=>clearInterval(u)},[c,t,m]),s.jsxs(s.Fragment,{children:[te.isMobile&&s.jsx(L,{onTouchStart:h,onTouchEnd:a,onClick:()=>{},...o,children:b}),!te.isMobile&&s.jsx(L,{onMouseDown:h,onMouseUp:a,onClick:()=>{},...o,children:b})]})},P=40,Fe=P/2+1,Ue=ae(()=>({container:{height:P,overflowY:"scroll",scrollSnapType:"y mandatory",scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"},textAlign:"center"},child:{scrollbarWidth:"none",scrollSnapAlign:"center","&::-webkit-scrollbar":{display:"none"},scrollSnapStop:"always"}})),qe=({currentMilliseconds:t,totalMilliseconds:e,offset:b,offsetInputRef:o,onOffset:c,playbackRate:p,playbackRateInputRef:m,onPlaybackRate:a,initialControlType:h,onScrollTo:u})=>{const y=Ue(),[C,T]=n.useState(l.timeDisplay),w=n.useRef(0),[i,r]=n.useState(0),F=n.useRef();F.current=i;const O=n.useRef(),M=n.useRef(),N=n.useRef(C),B=n.useRef();B.current=u,N.current=C;const U=n.useCallback(f=>{const k=f.currentTarget.scrollTop,x=k>w.current?Math.ceil(Math.floor(k)/P):Math.floor(k/P);i===2&&x!==C&&(u(x),T(x)),w.current=k},[u,i,C]),g=n.useCallback(f=>{var x,I;if(M.current!==void 0){f.preventDefault();return}if(Number.isInteger(f.deltaY)||f.deltaX!==0||Math.abs(f.deltaY)<1)return;f.preventDefault();const k=f.deltaY>0;let j=!1;k&&N.current<2?((x=O.current)==null||x.scrollBy({top:Fe,behavior:"smooth"}),j=!0):!k&&N.current>0&&((I=O.current)==null||I.scrollBy({top:-21,behavior:"smooth"}),j=!0),j&&(M.current!==void 0&&clearTimeout(M.current),M.current=setTimeout(()=>{M.current=void 0},500))},[]),W=n.useCallback(f=>{i>0||f&&(h===void 0?r(2):setTimeout(()=>{f.scrollTop=P*2;const k=(j,x)=>{f.scroll({top:j,behavior:"smooth"}),f.addEventListener("scrollend",I=>{var A,H;((A=I.currentTarget)==null?void 0:A.scrollTop)>=P*2||F.current===1&&((H=B.current)==null||H.call(B,x),T(x),r(2))}),r(1)};h===1?k(P+1,h):h===0?k(0,h):r(2)},0),f.addEventListener("wheel",g,{passive:!1}),f.addEventListener("scrollend",()=>{M.current=void 0}),O.current=f)},[i,h,g]);return s.jsxs("div",{ref:W,onScroll:U,className:y.container,children:[s.jsx(je,{currentMilliseconds:t,totalMilliseconds:e,className:y.child}),s.jsx(Re,{inputRef:o,offset:b,onOffset:c,className:y.child}),s.jsx(we,{inputRef:m,playbackRate:p,onPlaybackRate:a,className:y.child})]})},Ge=ae(({anchor:t})=>({button:{color:"white"},inactiveButton:{color:"rgba(120, 120, 120, 0.7)"},recordingButton:{color:"red"},container:{display:"inline-flex",width:"auto",backgroundColor:"rgba(0, 0, 0, .7)",borderRadius:16},playModePopOver:{"& .MuiPopover-paper":{maxHeight:"none"}},tooltip:{"& .MuiTooltip-tooltipPlacementTop":t==="top"?{marginTop:16}:{},"& .MuiTooltip-tooltipPlacementBottom":t==="bottom"?{marginBottom:16}:{}}})),Ye=oe.forwardRef(function({children:e,...b},o){return s.jsx(R,{ref:o,container:!0,alignContent:"center",justifyContent:"center",...b,children:e})}),$e=oe.forwardRef(function({model:e,className:b,anchor:o,tooltipsEnabled:c,initialControlType:p,onScrollToControlType:m,onMineSubtitle:a,onLoadSubtitles:h,onOffset:u,onPlaybackRate:y,onPlayModeSelected:C,onSeek:T,onToggleSubtitles:w},i){const r=Ge({anchor:o}),F=n.useRef(),O=n.useRef(),[M,N]=n.useState(!1),[B,U]=n.useState(),[g,W]=n.useState(l.timeDisplay),f=n.useCallback(S=>{W(S),m(S)},[m]),k=n.useCallback(()=>{N(!1),U(void 0)},[]),j=n.useCallback(S=>{U(S.currentTarget),N(!0)},[]),x=n.useCallback(S=>{C(S),N(!1)},[C]),I=n.useCallback(()=>{!e||e.previousSubtitleTimestamp===void 0||u(e.currentTimestamp-e.previousSubtitleTimestamp)},[u,e]),A=n.useCallback(()=>{!e||e.nextSubtitleTimestamp===void 0||u(e.currentTimestamp-e.nextSubtitleTimestamp)},[u,e]),H=n.useCallback(()=>{e&&u(e.offset+100)},[u,e]),K=n.useCallback(()=>{e&&u(e.offset-100)},[u,e]),q=n.useCallback(()=>{e&&y(Math.max(.1,e.playbackRate-.1))},[y,e]),G=n.useCallback(()=>{e&&y(Math.min(5,e.playbackRate+.1))},[y,e]),J=n.useCallback(()=>{!e||e.previousSubtitleTimestamp===void 0||T(e.previousSubtitleTimestamp)},[T,e]),Q=n.useCallback(()=>{e&&T(Math.max(0,e.currentTimestamp-1e4))},[T,e]),Z=n.useCallback(()=>{!e||e.nextSubtitleTimestamp===void 0||T(e.nextSubtitleTimestamp)},[T,e]),_=n.useCallback(()=>{e&&T(e.currentTimestamp+1e4)},[T,e]),ie=n.useCallback(()=>{switch(g){case l.timeDisplay:e!=null&&e.emptySubtitleTrack?Q():J();break;case l.subtitleOffset:I();break;case l.playbackRate:q();break}},[g,e==null?void 0:e.emptySubtitleTrack,Q,J,I,q]),le=n.useCallback(()=>{switch(g){case l.timeDisplay:e!=null&&e.emptySubtitleTrack?_():Z();break;case l.subtitleOffset:A();break;case l.playbackRate:G();break}},[g,e==null?void 0:e.emptySubtitleTrack,_,Z,A,G]),ue=n.useCallback(()=>{switch(g){case l.timeDisplay:break;case l.subtitleOffset:H();break;case l.playbackRate:q();break}},[g,H,q]),be=n.useCallback(()=>{switch(g){case l.timeDisplay:break;case l.subtitleOffset:K();break;case l.playbackRate:G();break}},[g,K,G]),{t:d}=ge(),{leftNumberControlTitle:de,numberControlTitle:pe,rightNumberControlTitle:fe}=n.useMemo(()=>{switch(g){case l.timeDisplay:return{leftNumberControlTitle:e!=null&&e.emptySubtitleTrack?d("binds.seekBackward"):d("binds.seekToPreviousSubtitle"),numberControlTitle:d("controls.currentTimestamp"),rightNumberControlTitle:e!=null&&e.emptySubtitleTrack?d("binds.seekForward"):d("binds.seekToNextSubtitle")};case l.subtitleOffset:return{leftNumberControlTitle:d("action.increaseOffsetButton"),numberControlTitle:d("controls.subtitleOffset"),rightNumberControlTitle:d("action.decreaseOffsetButton")};case l.playbackRate:return{leftNumberControlTitle:d("binds.decreasePlaybackRate"),numberControlTitle:d("controls.playbackRate"),rightNumberControlTitle:d("binds.increasePlaybackRate")}}},[g,e,d]);if(!e)return null;let V,z;switch(g){case l.timeDisplay:V=!e.emptySubtitleTrack&&e.nextSubtitleTimestamp===void 0||e.recording,z=!e.emptySubtitleTrack&&e.previousSubtitleTimestamp===void 0||e.recording||e.currentTimestamp===0;break;case l.subtitleOffset:V=e.nextSubtitleTimestamp===void 0||e.recording,z=e.previousSubtitleTimestamp===void 0||e.recording;break;case l.playbackRate:V=e.playbackRate>=5||e.recording,z=e.playbackRate<=.1||e.recording;break}const ee=!e.emptySubtitleTrack&&!e.subtitleDisplaying||e.recording;function me(S){if(!S)return null;if(S.emptySubtitleTrack)return S.recordingEnabled?S.recording?d("action.stopRecording"):d("action.startRecording"):d("action.mine");switch(S.postMineAction){case Y.exportCard:case Y.showAnkiDialog:case Y.none:return d("action.mine");case Y.updateLastCard:return d("action.updateLastCard")}}const E={className:r.tooltip,placement:o,disabled:!c},he=b===void 0?r.container:`${b} ${r.container}`;return s.jsxs(s.Fragment,{children:[s.jsxs(Ye,{ref:i,direction:"row",wrap:"nowrap",className:he,children:[h&&s.jsx(R,{item:!0,children:s.jsx(D,{...E,title:d("action.loadSubtitles"),children:s.jsx("span",{children:s.jsx(L,{disabled:e.recording,onClick:h,children:s.jsx(Pe,{className:e.recording?r.inactiveButton:r.button})})})})}),s.jsx(R,{item:!0,children:s.jsx(D,{...E,title:me(e),children:e.emptySubtitleTrack&&e.recordingEnabled?s.jsx("span",{children:s.jsx(L,{onClick:a,children:s.jsx(Ne,{className:e.recording?r.recordingButton:r.button})})}):s.jsx("span",{children:s.jsx(L,{disabled:ee,onClick:a,children:s.jsx(Ie,{className:ee?r.inactiveButton:r.button})})})})}),!e.emptySubtitleTrack&&s.jsx(R,{item:!0,children:s.jsx(D,{...E,title:d("binds.toggleSubtitles"),children:s.jsx("span",{children:s.jsxs(L,{disabled:e.recording,onClick:w,children:[e.subtitlesAreVisible&&s.jsx(ze,{className:e.recording?r.inactiveButton:r.button}),!e.subtitlesAreVisible&&s.jsx(Ee,{className:e.recording?r.inactiveButton:r.button})]})})})}),!e.emptySubtitleTrack&&s.jsx(R,{item:!0,children:s.jsx(D,{...E,title:d("controls.playbackMode"),children:s.jsx("span",{children:s.jsx(L,{disabled:e.recording,onClick:j,children:s.jsx(De,{className:e.recording?r.inactiveButton:r.button})})})})}),!e.recording&&s.jsxs(s.Fragment,{children:[s.jsx(R,{item:!0,children:s.jsx(D,{...E,title:de,children:s.jsx("span",{children:s.jsx(se,{onClick:ie,onHold:ue,disabled:z,children:s.jsx(He,{className:z?r.inactiveButton:r.button})})})})}),s.jsx(D,{...E,title:pe,children:s.jsx(R,{item:!0,children:s.jsx(qe,{offsetInputRef:F,playbackRateInputRef:O,offset:e.offset,onOffset:u,playbackRate:e.playbackRate,onPlaybackRate:y,initialControlType:p,onScrollTo:f,currentMilliseconds:e.currentTimestamp})})}),s.jsx(R,{item:!0,children:s.jsx(D,{...E,title:fe,children:s.jsx("span",{children:s.jsx(se,{onClick:le,onHold:be,disabled:V,children:s.jsx(Ve,{className:V?r.inactiveButton:r.button})})})})})]})]}),M&&s.jsx(Le,{open:M,anchorEl:B,onClose:k,selectedPlayMode:e.playMode,onPlayMode:x,listStyle:{display:"flex",flexDirection:"row",padding:0,overflowX:"auto"},className:r.playModePopOver,anchorOrigin:{vertical:"center",horizontal:"center"},transformOrigin:{vertical:"center",horizontal:"center"}})]})});var ne;const We=navigator.userAgent.toLowerCase().includes("android")??((ne=navigator.userAgentData)==null?void 0:ne.mobile)??!1,Xe=({isMobile:t,fetchLastControlType:e,saveLastControlType:b})=>{const o=n.useMemo(()=>t?l.timeDisplay:l.subtitleOffset,[t]),[c,p]=n.useState(o);n.useEffect(()=>{e().then(a=>{p(a===void 0?o:a)})},[o,e]);const m=n.useCallback(a=>{p(a),b(a)},[b]);return{lastControlType:c,setLastControlType:m}},Ke=new ve(new Te),ce=new URLSearchParams(location.search),$=ce.get("anchor"),Je=ce.get("tooltips")==="true",Qe=48,Ze=100,X="lastScrollableControlType",_e=async()=>{const t=await v.storage.local.get(X);return t?t[X]:void 0},et=async t=>{await v.storage.local.set({[X]:t})},tt=()=>{const t=Ae(),e=n.useRef(!1),b=n.useCallback(async()=>{if(!t)return;const i={sender:"asbplayerv2",message:{command:"copy-subtitle",postMineAction:await Ke.getSingle("clickToMineDefaultAction")},tabId:t.tabId,src:t.src};v.runtime.sendMessage(i)},[t]),o=n.useCallback(()=>{if(!t)return;const i={sender:"asbplayerv2",message:{command:"load-subtitles"},tabId:t.tabId,src:t.src};v.runtime.sendMessage(i)},[t]),c=n.useCallback(i=>{if(!t)return;const r={sender:"asbplayerv2",message:{command:"offset",value:i,echo:!0},tabId:t.tabId,src:t.src};v.runtime.sendMessage(r)},[t]),p=n.useCallback(i=>{if(!t)return;const r={sender:"asbplayerv2",message:{command:"currentTime",value:i/1e3},tabId:t.tabId,src:t.src};v.runtime.sendMessage(r)},[t]),m=n.useCallback(i=>{if(!t)return;const r={sender:"asbplayerv2",message:{command:"playbackRate",value:i},tabId:t.tabId,src:t.src};v.runtime.sendMessage(r)},[t]),a=Oe({location:t}),h=n.useCallback(i=>{if(!t)return;const r={sender:"asbplayer-mobile-overlay-to-video",message:{command:"playMode",playMode:i},src:t.src};v.runtime.sendMessage(r)},[t]),u=n.useCallback(()=>{if(!t)return;const i={sender:"asbplayer-mobile-overlay-to-video",message:{command:"toggle-subtitles"},src:t.src};v.runtime.sendMessage(i)},[t]);n.useEffect(()=>{const i=()=>{if(t&&!e.current&&($==="top"&&document.body.scrollTop>=Qe||$==="bottom"&&document.body.scrollTop<=Ze)){const r={sender:"asbplayer-mobile-overlay-to-video",message:{command:"hidden"},src:t.src};v.runtime.sendMessage(r),e.current=!0}};return document.body.addEventListener("scrollend",i),()=>document.body.removeEventListener("scrollend",i)},[t]),n.useEffect(()=>{$==="top"?(document.documentElement.scrollTop=0,document.body.scrollTop=0):(document.documentElement.scrollTop=document.documentElement.scrollHeight,document.body.scrollTop=document.body.scrollHeight)},[]);const{initialized:y}=ke({language:(a==null?void 0:a.language)??"en"}),{lastControlType:C,setLastControlType:T}=Xe({isMobile:We,saveLastControlType:et,fetchLastControlType:_e}),w=n.useMemo(()=>(a==null?void 0:a.themeType)===void 0?void 0:Se(a==null?void 0:a.themeType),[a==null?void 0:a.themeType]);return!y||C===void 0||!w?null:s.jsx(Be,{injectFirst:!0,children:s.jsxs(xe,{theme:w,children:[s.jsx(Ce,{}),s.jsx($e,{model:a,anchor:$,tooltipsEnabled:Je,initialControlType:C,onScrollToControlType:T,onMineSubtitle:b,onLoadSubtitles:o,onOffset:c,onSeek:p,onPlaybackRate:m,onPlayModeSelected:h,onToggleSubtitles:u})]})})};async function st(t){Me.createRoot(t).render(s.jsx(tt,{}))}window.addEventListener("load",()=>{const t=document.getElementById("root"),b=new URLSearchParams(location.search).get("anchor"),o=document.createElement("div");o.className="asbplayer-mobile-video-overlay-scroll-buffer",b==="bottom"?(t.style.bottom="0px",document.body.prepend(o)):(t.style.top="0px",document.body.appendChild(o)),st(t)});
