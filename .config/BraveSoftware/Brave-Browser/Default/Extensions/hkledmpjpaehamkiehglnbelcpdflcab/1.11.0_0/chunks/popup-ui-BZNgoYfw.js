import{b as i}from"./index-BNzDLOmD.js";import{j as s,o as L,n as A,h as C,f as I,r as a,d as k,G as g,l as P,v as E,S as T,E as j,e as M,T as R,C as F,P as q,k as O}from"./Tooltip-CHkWPQyT.js";import{A as B,b as U,a as V,S as z,c as H,u as G}from"./SettingsProfileSelectMenu-DvRtSy1I.js";import{a as y,B as K}from"./index-BSUPl2ka.js";import{S as W}from"./Input-CyGuovd8.js";import"./TableContainer-CRv4wqnM.js";import"./mp3-encoder-CoEoOaGq.js";import"./index-DGAt_zbA.js";import"./LogoIcon-B8iZypNR.js";import"./TutorialBubble-5H5VcrSJ.js";const D=()=>s.jsx(L,{children:s.jsx("path",{d:"M 2 2 V 22 H 23 L 23 19 L 5 19 L 5 19 L 5 5 L 13 5 L 13 2 M 13 2 L 13 19 L 23 19 L 23 2"})}),$=A(s.jsx("path",{d:"M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"}),"Launch");class J{fetch(e,t){const o={sender:"asbplayer-popup",message:{command:"http-post",url:e,body:t,messageId:""}};return i.runtime.sendMessage(o)}}const N=({settings:n,commands:e,onOpenApp:t,onOpenSidePanel:o,onSettingsChanged:c,onOpenExtensionShortcuts:u,...l})=>{const{t:h}=C(),{initialized:b}=I({language:n.language}),p=a.useMemo(()=>new B(n,new J),[n]),d=a.useCallback(()=>{i.tabs.create({url:`${i.runtime.getURL("/options.html")}#subtitle-appearance`,active:!0})},[]),{supportedLanguages:x}=U(),{localFontsAvailable:f,localFontsPermission:m,localFontFamilies:v}=V(),r=k();return b?s.jsxs(g,{container:!0,direction:"column",spacing:0,children:[s.jsx(g,{item:!0,style:{marginLeft:r.spacing(2),marginTop:r.spacing(2),marginRight:r.spacing(2)},children:s.jsx(y,{variant:"contained",color:"primary",startIcon:s.jsx($,{}),onClick:t,style:{width:"100%"},children:h("action.openApp")})}),!P.isMobile&&!0&&s.jsx(g,{item:!0,style:{marginLeft:r.spacing(2),marginTop:r.spacing(1),marginRight:r.spacing(2)},children:s.jsx(y,{variant:"contained",color:"primary",startIcon:s.jsx(D,{}),onClick:o,style:{width:"100%"},children:h("action.openSidePanel")})}),s.jsx(g,{item:!0,style:{height:P.isMobile?"auto":390,marginLeft:r.spacing(1),marginTop:r.spacing(1),marginRight:r.spacing(1)},children:s.jsx(z,{extensionInstalled:!0,extensionVersion:i.runtime.getManifest().version,extensionSupportsAppIntegration:!0,extensionSupportsOverlay:!0,extensionSupportsSidePanel:!0,extensionSupportsOrderableAnkiFields:!0,extensionSupportsTrackSpecificSettings:!0,extensionSupportsSubtitlesWidthSetting:!0,extensionSupportsPauseOnHover:!0,extensionSupportsExportCardBind:!0,forceVerticalTabs:!1,anki:p,chromeKeyBinds:E(e),settings:n,localFontsAvailable:f,localFontsPermission:m,localFontFamilies:v,supportedLanguages:x,onSettingsChanged:c,onOpenChromeExtensionShortcuts:u,onUnlockLocalFonts:d})}),s.jsx(g,{item:!0,style:{marginLeft:r.spacing(2),marginTop:r.spacing(1),marginRight:r.spacing(2),marginBottom:r.spacing(2)},children:s.jsx(H,{...l})})]}):null},S="tabRequestingActiveTabPermission",Q=async()=>{const n=await i.storage.session.get(S),e=n?n[S]:void 0;if(e===void 0)return;const t=await X(e.tabId);if(t===void 0||t.url!==e.url){await i.storage.session.remove(S);return}return{tabId:e.tabId,src:e.src}},X=async n=>await i.tabs.get(n),Y=()=>{const[n,e]=a.useState(),[t,o]=a.useState();return a.useEffect(()=>{(async()=>{const u=await Q();if(u===void 0)e(!1);else{const l=await i.tabs.query({active:!0,currentWindow:!0});l.length>0&&l[0].id===u.tabId?(e(!0),o(u)):e(!1)}})()},[]),{requestingActiveTabPermission:n,tabRequestingActiveTabPermission:t}},w=()=>{const n={sender:"asbplayer-popup",message:{command:"settings-updated"}};i.runtime.sendMessage(n)};function Z({commands:n}){const e=a.useMemo(()=>new T(new j),[]),[t,o]=a.useState(),c=a.useMemo(()=>t&&M(t.themeType),[t]);a.useEffect(()=>{e.getAll().then(o)},[e]);const u=a.useCallback(async m=>{o(v=>({...v,...m})),await e.set(m),w()},[e]),l=a.useCallback(()=>{i.tabs.create({active:!0,url:"chrome://extensions/shortcuts"})},[]),h=a.useCallback(async()=>{t!=null&&t.streamingAppUrl&&i.tabs.create({active:!0,url:t.streamingAppUrl})},[t]),b=a.useCallback(async()=>{i.sidePanel.open({windowId:(await i.windows.getLastFocused()).id})},[]),{requestingActiveTabPermission:p,tabRequestingActiveTabPermission:d}=Y();a.useEffect(()=>{if(!p||d===void 0)return;const m={sender:"asbplayer-extension-to-video",message:{command:"granted-active-tab-permission"},src:d.src};i.tabs.sendMessage(d.tabId,m),window.close()},[p,d]);const x=a.useCallback(()=>{e.getAll().then(o),w()},[e]),f=G({settingsProvider:e,onProfileChanged:x});return!t||!c||p===void 0?null:s.jsx(W,{injectFirst:!0,children:s.jsxs(R,{theme:c,children:[s.jsx(F,{}),s.jsx(q,{square:!0,style:{backgroundImage:t.themeType==="dark"?"linear-gradient(rgba(255, 255, 255, 0.165), rgba(255, 255, 255, 0.165))":"none",width:P.isMobile?"100%":600},children:s.jsx(K,{children:s.jsx(N,{commands:n,settings:t,onSettingsChanged:u,onOpenApp:h,onOpenSidePanel:b,onOpenExtensionShortcuts:l,...f})})})]})})}async function _(n,{commands:e}){O.createRoot(n).render(s.jsx(Z,{commands:e}))}const ee=()=>new Promise((n,e)=>{if(i.commands===void 0){n({});return}i.commands.getAll(t=>{const o={};for(const c of t)c.name&&c.shortcut&&(o[c.name]=c.shortcut);n(o)})});document.addEventListener("DOMContentLoaded",async n=>{const t=new T(new j).getAll(),o=ee();await t;const c=await o,u=document.getElementById("root");await _(u,{commands:c})});
