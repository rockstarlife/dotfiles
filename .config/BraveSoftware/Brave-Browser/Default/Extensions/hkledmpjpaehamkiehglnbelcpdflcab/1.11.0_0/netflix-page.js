var netflixPage=function(){"use strict";function P(r){return r==null||typeof r=="function"?{main:r}:r}function S(r,w=1e4){return new Promise(async(c,h)=>{r()&&c(!0);const b=Date.now();let i=!1;for(;!i&&Date.now()<b+w;)await new Promise(v=>{setTimeout(()=>{i=r(),v()},1e3)});c(i)})}const $=r=>({id:N(r),...r}),N=r=>`${r.language}:${r.label}:${r.url}`,L=P(()=>{setTimeout(()=>{const r="webvtt-lssdh-ios8",w=new RegExp("manifest|licensedManifest"),c=new Map;function h(){var e,t,n,s;if(!(typeof netflix>"u"))return(s=(n=(t=(e=netflix==null?void 0:netflix.appContext)==null?void 0:e.state)==null?void 0:t.playerApp)==null?void 0:n.getAPI)==null?void 0:s.call(n)}function b(){var e;return(e=h())==null?void 0:e.videoPlayer}function i(){var t,n;const e=b();if(e){const s=((t=e.getAllPlayerSessionIds)==null?void 0:t.call(e))||[];if(s.length===0){console.error("No Netflix player session IDs");return}const a=s[s.length-1];return(n=e.getVideoPlayerBySessionId)==null?void 0:n.call(e,a)}console.error("Missing netflix global")}function v(e){var n,s;if(e.isForcedNarrative||e.isNoneTrack||!((n=e.cdnlist)!=null&&n.length)||!e.ttDownloadables)return;const t=e.ttDownloadables[r];if(t!=null&&t.downloadUrls)return t.downloadUrls[(s=e.cdnlist.find(a=>t.downloadUrls[a.id]))==null?void 0:s.id]}function M(e){if(e.isForcedNarrative||e.isNoneTrack||!e.ttDownloadables)return;const t=e.ttDownloadables[r];return!(t!=null&&t.urls)||t.urls.length===0?"lazy":t.urls[0].url}function D(e){const t=e.timedtexttracks||[];for(const n of t){const s=v(n)??M(n);s!==void 0&&(c.has(e.movieId)||c.set(e.movieId,new Map),c.get(e.movieId).set(n.new_track_id,s))}}document.addEventListener("asbplayer-netflix-seek",e=>{var t;(t=i())==null||t.seek(e.detail)}),document.addEventListener("asbplayer-netflix-play",()=>{var e;(e=i())==null||e.play()}),document.addEventListener("asbplayer-netflix-pause",()=>{var e;(e=i())==null||e.pause()});function O(e){var a,g,o,T,d,l,p,x,u,y;const t=(T=(o=(g=(a=h())==null?void 0:a.getVideoMetadataByVideoId)==null?void 0:g.call(a,e))==null?void 0:o.getCurrentVideo)==null?void 0:T.call(o),n=(d=t==null?void 0:t.getTitle)==null?void 0:d.call(t);if(typeof n!="string")return[`${e}`,!0];let s=n;if(((l=t==null?void 0:t.isEpisodic)==null?void 0:l.call(t))===!0){const z=`${(x=(p=t==null?void 0:t.getSeason())==null?void 0:p._season)==null?void 0:x.seq}`.padStart(2,"0"),B=`${(u=t==null?void 0:t.getEpisodeNumber)==null?void 0:u.call(t)}`.padStart(2,"0"),J=(y=t==null?void 0:t.getEpisodeTitle)==null?void 0:y.call(t);s+=` S${z}E${B} ${J}`}return[s,!1]}async function I(e,t){if(t<=0)return`${e}`;const[n,s]=O(e);return s?(await new Promise(a=>setTimeout(a,1e3)),await I(e,--t)):n}const k=(e,t)=>{if(!e.bcp47)return;const n=e.rawTrackType==="CLOSEDCAPTIONS",s=n?`${e.bcp47.toLowerCase()}-CC`:e.bcp47.toLowerCase(),a=`${e.bcp47} - ${e.displayName}${n?" [CC]":""}`;return $({label:a,language:s,url:t.get(e.trackId)??"lazy",extension:"nfvtt"})},E=async()=>{const e={error:"",basename:"",subtitles:[]},t=i(),n=t==null?void 0:t.getMovieId();if(!t||!n)return e.error="Netflix Player or Title Id not found...",e;e.basename=await I(n,5);const s=c.get(n)||new Map;return e.subtitles=t.getTimedTextTrackList().filter(a=>s.has(a.trackId)).map(a=>k(a,s)).filter(a=>a!==void 0),e};document.addEventListener("asbplayer-get-synced-data",async()=>{const e=await E();document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:e}))},!1);const C=async e=>{var g;const t=o=>{document.dispatchEvent(new CustomEvent("asbplayer-synced-language-data",{detail:{error:o??"Failed to fetch subtitles for requested language",basename:"",subtitles:[]}}))},n=i();if(n===void 0){t();return}const s=n.getTimedTextTrack();let a=!1;try{const T=e.detail,d=c.get(n.getMovieId())||new Map,l=(g=n.getTimedTextTrackList())==null?void 0:g.find(u=>{var y;return((y=k(u,d))==null?void 0:y.language)===T});if(l===void 0){t();return}const p=d.get(l.trackId);if(p!==void 0&&p!=="lazy"){document.dispatchEvent(new CustomEvent("asbplayer-synced-language-data",{detail:await E()}));return}if(await n.setTimedTextTrack(l),a=!0,!await S(()=>{const u=d.get(l.trackId);return u!==void 0&&u!=="lazy"})){t();return}document.dispatchEvent(new CustomEvent("asbplayer-synced-language-data",{detail:await E()}))}catch(o){t(o instanceof Error?o.message:String(o))}finally{a&&s!==void 0&&await n.setTimedTextTrack(s)}};let f;document.addEventListener("asbplayer-get-synced-language-data",async e=>{f===void 0?f=C(e):f.then(()=>C(e)),await f,f=void 0},!1);const U=JSON.stringify;JSON.stringify=function(e){var t;if(typeof(e==null?void 0:e.url)=="string"&&-1<e.url.search(w))for(let n of Object.values(e))(t=n==null?void 0:n.profiles)==null||t.unshift(r);return U.apply(this,arguments)};const R=JSON.parse;JSON.parse=function(){var t;const e=R.apply(this,arguments);return(t=e==null?void 0:e.result)!=null&&t.movieId&&D(e.result),e},Function.prototype.apply=new Proxy(Function.prototype.apply,{apply:function(e,t,n){if(n&&n[1]&&typeof n[1][0]=="string"){const s=n[1][0];if(s==="preciseSeeking"||s==="preciseseeking"||s==="preciseseekingontwocoredevice")return!0}return e.call(t,...n)}}),document.addEventListener("asbplayer-query-netflix",async()=>{const e=await S(()=>b()!==void 0,3e4);document.dispatchEvent(new CustomEvent("asbplayer-netflix-enabled",{detail:e}))})},0)});function q(){}function m(r,...w){}const F={debug:(...r)=>m(console.debug,...r),log:(...r)=>m(console.log,...r),warn:(...r)=>m(console.warn,...r),error:(...r)=>m(console.error,...r)};return(async()=>{try{return await L.main()}catch(r){throw F.error('The unlisted script "netflix-page" crashed on startup!',r),r}})()}();
netflixPage;
