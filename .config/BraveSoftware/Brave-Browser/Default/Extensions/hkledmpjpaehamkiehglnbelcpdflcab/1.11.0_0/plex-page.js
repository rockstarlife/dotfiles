var plexPage=function(){"use strict";function p(e){return e==null||typeof e=="function"?{main:e}:e}const f=e=>({id:g(e),...e}),g=e=>`${e.language}:${e.label}:${e.url}`,h=p(()=>{let e,a,l;const x=window.fetch;window.fetch=(...t)=>{for(const r of t){const n=typeof r=="string"?r:r instanceof Request?r.url:null;if(!n)continue;if(!a){const u=n.match(/X-Plex-Token=([^&]+)/i);u&&(e=new URL(n).origin,a=u[1])}let o=n.match(/library%2Fmetadata%2F(\d+)/i);o&&(l=o[1]),o=n.match(/ratingKey=(\d+)/i),o&&(l=o[1]);const i=n.match(/\/transcode\/universal\/.+?\?/i);i&&n.replace(i[0],"/transcode/universal/subtitles?")}return x(...t)},document.addEventListener("asbplayer-get-synced-data",async()=>{const t={error:"",basename:"",subtitles:[]},r="Automatic detection does not work for Plex if you resume playing your previous session from the mini player. Try stopping the video and hitting play on the media directly.",n=new DOMParser;if(!e||!a)return t.error=`Could not get the Plex server URL or token. ${r}`,document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:t}));if(!l)return t.error=`Could not get the ratingKey for the Plex media. ${r}`,document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:t}));const i=await(await fetch(`${e}/library/metadata/${l}?X-Plex-Token=${a}`)).text(),d=n.parseFromString(i,"application/xml").querySelector("Video");if(!d)return t.error=`No metadata found for Plex video. ${r}: ${i}`,document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:t}));t.basename=d.getAttribute("title")??"Unknown";const y=[];d.querySelectorAll("Part").forEach(v=>{v.querySelectorAll('Stream[streamType="3"]').forEach(c=>{const m=c.getAttribute("key");if(m){y.push(f({label:c.getAttribute("extendedDisplayTitle")??"",language:c.getAttribute("language")??"",url:`${e}${m}?X-Plex-Token=${a}`,extension:c.getAttribute("codec")??""}));return}t.error="Automatic detection is only available for external subtitles on Plex. If none are available, try Plex's subtitle search or use your own."})}),t.subtitles=y,document.dispatchEvent(new CustomEvent("asbplayer-synced-data",{detail:t}))},!1)});function w(){}function s(e,...a){}const b={debug:(...e)=>s(console.debug,...e),log:(...e)=>s(console.log,...e),warn:(...e)=>s(console.warn,...e),error:(...e)=>s(console.error,...e)};return(async()=>{try{return await h.main()}catch(e){throw b.error('The unlisted script "plex-page" crashed on startup!',e),e}})()}();
plexPage;
